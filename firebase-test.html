<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .migration-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase</h1>
        
        <div class="test-section">
            <h3>1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Firebase</h3>
            <div id="config-status" class="status info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
            <button onclick="testFirebaseConfig()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤</button>
        </div>

        <div class="test-section">
            <h3>2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore</h3>
            <div id="firestore-status" class="status info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
            <button onclick="testFirestoreConnection()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore</button>
        </div>

        <div class="test-section">
            <h3>3. ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Migration)</h3>
            <div id="migration-status" class="status info">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            <div class="migration-controls">
                <button onclick="runDataMigration()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button onclick="checkMigrationStatus()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                <button onclick="clearFirestoreData()" style="background-color: #dc3545;">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firestore</button>
            </div>
            <div id="migration-log" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API Functions</h3>
            <div id="api-status" class="status info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
            <div class="migration-controls">
                <button onclick="testGetUsers()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö getUsers()</button>
                <button onclick="testGetTransports()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö getTransports()</button>
                <button onclick="testAuthentication()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Authentication</button>
            </div>
            <div id="api-log" class="log" style="display: none;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { FirebaseUtils } from './firebase-config.js';
         import firebaseAPI from './firebase-api.js';
         import { runMigration } from './migration.js';

        // Global functions for testing
        window.testFirebaseConfig = async function() {
            const statusEl = document.getElementById('config-status');
            try {
                if (FirebaseUtils.isConfigured()) {
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ Firebase ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Project: wh1-transport)';
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = '‚ùå Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
            }
        };

        window.testFirestoreConnection = async function() {
            const statusEl = document.getElementById('firestore-status');
            statusEl.className = 'status info';
            statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore...';
            
            try {
                // Try to read from a test collection
                const testCollection = collection(getFirestore(), 'test');
                await getDocs(testCollection);
                
                statusEl.className = 'status success';
                statusEl.textContent = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore: ${error.message}`;
                console.error('Firestore connection error:', error);
            }
        };

        window.runDataMigration = async function() {
            const statusEl = document.getElementById('migration-status');
            const logEl = document.getElementById('migration-log');
            
            statusEl.className = 'status info';
            statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            logEl.style.display = 'block';
            logEl.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...\n';
            
            try {
                const result = await runMigration();
                
                if (result.success) {
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = `‚ùå ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.error}`;
                }
                
                logEl.textContent = result.log.join('\n');
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`;
                logEl.textContent += `\nError: ${error.message}`;
                console.error('Migration error:', error);
            }
        };

        window.checkMigrationStatus = async function() {
            const statusEl = document.getElementById('migration-status');
            const logEl = document.getElementById('migration-log');
            
            try {
                const users = await firebaseAPI.getUsers();
                const transports = await firebaseAPI.getTransports();
                const vehicles = await firebaseAPI.getVehicles();
                
                statusEl.className = 'status info';
                statusEl.textContent = `üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firestore: ${users.length} users, ${transports.length} transports, ${vehicles.length} vehicles`;
                
                logEl.style.display = 'block';
                logEl.textContent = `Users: ${users.length}\nTransports: ${transports.length}\nVehicles: ${vehicles.length}\n\nSample data:\n${JSON.stringify({users: users.slice(0,2), transports: transports.slice(0,2)}, null, 2)}`;
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`;
            }
        };

        window.clearFirestoreData = async function() {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Firestore?')) {
                return;
            }
            
            const statusEl = document.getElementById('migration-status');
            statusEl.className = 'status info';
            statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            try {
                // This is a simplified version - in production you'd want batch deletes
                const collections = ['users', 'transports', 'vehicles', 'notifications'];
                
                for (const collectionName of collections) {
                    const snapshot = await getDocs(collection(getFirestore(), collectionName));
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                }
                
                statusEl.className = 'status success';
                statusEl.textContent = '‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firestore ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`;
            }
        };

        window.testGetUsers = async function() {
            const logEl = document.getElementById('api-log');
            const statusEl = document.getElementById('api-status');
            
            logEl.style.display = 'block';
            logEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö getUsers()...\n';
            
            try {
                const users = await firebaseAPI.getUsers();
                statusEl.className = 'status success';
                statusEl.textContent = `‚úÖ getUsers() ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏û‡∏ö ${users.length} users`;
                logEl.textContent += `\n‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:\n${JSON.stringify(users, null, 2)}`;
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå getUsers() ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`;
                logEl.textContent += `\nError: ${error.message}`;
            }
        };

        window.testGetTransports = async function() {
            const logEl = document.getElementById('api-log');
            const statusEl = document.getElementById('api-status');
            
            logEl.style.display = 'block';
            logEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö getTransports()...\n';
            
            try {
                const transports = await firebaseAPI.getTransports();
                statusEl.className = 'status success';
                statusEl.textContent = `‚úÖ getTransports() ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏û‡∏ö ${transports.length} transports`;
                logEl.textContent += `\n‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:\n${JSON.stringify(transports, null, 2)}`;
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå getTransports() ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`;
                logEl.textContent += `\nError: ${error.message}`;
            }
        };

        window.testAuthentication = async function() {
            const logEl = document.getElementById('api-log');
            const statusEl = document.getElementById('api-status');
            
            logEl.style.display = 'block';
            logEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Authentication...\n';
            
            try {
                const user = await firebaseAPI.authenticateUser('admin', 'admin123');
                if (user) {
                    statusEl.className = 'status success';
                    statusEl.textContent = `‚úÖ Authentication ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user.username}`;
                    logEl.textContent += `\n‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö:\n${JSON.stringify(user, null, 2)}`;
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = '‚ùå Authentication ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß - ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                    logEl.textContent += '\n‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå Authentication ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`;
                logEl.textContent += `\nError: ${error.message}`;
            }
        };

        // Auto-test configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            testFirebaseConfig();
        });
    </script>
</body>
</html>